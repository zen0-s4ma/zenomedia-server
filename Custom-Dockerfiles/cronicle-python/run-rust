#!/usr/bin/env bash
set -euo pipefail

TARGET="${1:-}"
if [[ -z "${TARGET}" ]]; then
  echo "[run-rust] Usage:"
  echo "  run-rust /scripts/my_project_dir [-- cargo-args]"
  echo "  run-rust /scripts/tool.rs [-- args]"
  exit 2
fi
shift || true

CACHE_DIR="${RUST_CACHE_DIR:-/opt/cronicle/data/rust}"
mkdir -p "${CACHE_DIR}/cargo" "${CACHE_DIR}/target" "${CACHE_DIR}/bin"

export CARGO_HOME="${CACHE_DIR}/cargo"
export CARGO_TARGET_DIR="${CACHE_DIR}/target"

if [[ -d "${TARGET}" && -f "${TARGET}/Cargo.toml" ]]; then
  echo "[run-rust] Cargo project detected: ${TARGET}"
  cd "${TARGET}"
  exec cargo run --release -- "$@"
fi

if [[ -f "${TARGET}" && "${TARGET}" == *.rs ]]; then
  echo "[run-rust] Rust file detected: ${TARGET}"
  BIN_ID="$(printf "%s" "${TARGET}" | sha256sum | awk '{print $1}')"
  OUT="${CACHE_DIR}/bin/${BIN_ID}"

  SRC_HASH="$(sha256sum "${TARGET}" | awk '{print $1}')"
  HASH_FILE="${OUT}.sha256"
  PREV_HASH=""
  [[ -f "${HASH_FILE}" ]] && PREV_HASH="$(cat "${HASH_FILE}" || true)"

  if [[ ! -x "${OUT}" || "${SRC_HASH}" != "${PREV_HASH}" ]]; then
    echo "[run-rust] Compiling (changed/new)"
    rustc -O "${TARGET}" -o "${OUT}"
    echo "${SRC_HASH}" > "${HASH_FILE}"
  else
    echo "[run-rust] Binary OK (cached)"
  fi

  exec "${OUT}" "$@"
fi

echo "[run-rust] ERROR: Not a Cargo project nor a .rs file: ${TARGET}" >&2
exit 2