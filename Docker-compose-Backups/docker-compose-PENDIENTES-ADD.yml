# ZENOMEDIA SERVER V0.1
services:
  # --- IPTV proxy (xTeVe moderno) ------------------------------------------
  threadfin:
    image: fyb3roptik/threadfin:latest
    container_name: threadfin
    ports:
      - "34400:34400"
    environment:
      - TZ=Europe/Madrid
      - PUID=1000
      - PGID=1000
    volumes:
      - "E:/Docker_folders/threadfin/conf:/home/threadfin/conf"
      - "E:/Docker_folders/threadfin/playlists:/playlists:ro"
      - "C:/Docker_folders/threadfin/tmp:/tmp/threadfin:rw"
    restart: unless-stopped

  # --- Backend PVR completo (timeshift/DVR) --------------------------------
  tvheadend:
    image: lscr.io/linuxserver/tvheadend:latest
    container_name: tvheadend
    network_mode: "service:gluetun"
    depends_on:
      - gluetun
    environment:
      - TZ=Europe/Madrid
      - PUID=1000
      - PGID=
    # ports:
    #   - "9981:9981"
    #   - "9982:9982"
    volumes:
      - "E:/Docker_folders/tvheadend/config:/config"
      - "E:/Docker_folders/tvheadend/tvheadend/recordings:/recordings"
      - "E:/Docker_folders/tvheadend/iptv:/iptv"
    restart: unless-stopped

  

  # --- TDARR ---------------------------------------------------------------
  tdarr:
    image: ghcr.io/haveagitgat/tdarr:latest
    container_name: tdarr
    ports:
      - "33081:8265"
      - "33082:8266"
    environment:
      - TZ=Europe/Madrid
      - PUID=1000
      - PGID=1000
      - UMASK_SET=002
      - serverIP=0.0.0.0
      - serverPort=8266
      - webUIPort=8265
      - internalNode=true
      - inContainer=true
      - ffmpegVersion=7
      - nodeName=InternalNode
      - auth=false
      - NVIDIA_DRIVER_CAPABILITIES=all
      - NVIDIA_VISIBLE_DEVICES=all
    volumes:
      - "E:/Docker_folders/tdarr/tdarr_server:/app/server"
      - "E:/Docker_folders/tdarr/tdarr_configs:/app/configs"
      - "E:/Docker_folders/tdarr/tdarr_logs:/app/logs"
      - "C:/Docker_folders/tdarr/tdarr_cache:/temp"
      # UNIDAD DE ALMACENAMIENTO F (CONTENIDO MULTIMEDIA):
      - "F:/Infantil:/media/Infantil"
      - "F:/Peliculas:/media/Peliculas"
      - "F:/Documentales:/media/Documentales"
      - "F:/Series:/media/Series"
      - "F:/MiniSeries:/media/MiniSeries"
      - "F:/Anime:/media/Anime"
      - "F:/Futbol:/media/Futbol"
      - "F:/Baloncesto:/media/Baloncesto"
      - "F:/NFL:/media/NFL"
      - "F:/Combates:/media/Combates"
      - "F:/LoL:/media/LoL"
      - "F:/Olimpiadas:/media/Olimpiadas"
      # UNIDAD DE ALMACENAMIENTO E (CONTENIDO MULTIMEDIA):
      - "E:/Infantil:/media/Infantil2"
      - "E:/Peliculas:/media/Peliculas2"
      - "E:/Series:/media/Series2"
      - "E:/MiniSeries:/media/MiniSeries2"
      - "E:/YouTube:/media/YouTube2"
      - "E:/Anime:/media/Anime2"
      - "E:/Documentales:/media/Documentales2"
      - "E:/Futbol:/media/Futbol2"
      - "E:/Baloncesto:/media/Baloncesto2"
      - "E:/NFL:/media/NFL2"
      - "E:/Combates:/media/Combates2"
      - "E:/LoL:/media/LoL2"
      - "E:/Olimpiadas:/media/Olimpiadas2"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    restart: unless-stopped

  # --- KAVITA --------------------------------------------------------------
  kavita:
    image: lscr.io/linuxserver/kavita:latest
    container_name: kavita
    ports: ["33086:5000"]
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Madrid
    volumes:
      - "E:/Docker_folders/kavita/kavita_config:/config"
      - "E:/Docker_folders/kavita/kavita_data:/data"
    restart: unless-stopped

  audiobookshelf:
    image: ghcr.io/advplyr/audiobookshelf:latest
    container_name: audiobookshelf
    ports:
      - "13378:80"
    environment:
      - TZ=Europe/Madrid
      - DISABLE_SSRF_REQUEST_FILTER=1
    volumes:
      - "E:/Docker_folders/audiobookshelf/audiobookshelf_config:/config"
      - "E:/Docker_folders/audiobookshelf/audiobookshelf_metadata:/metadata"
      - "F:/Audiolibros:/audiobooks"
      - "F:/Podcasts:/podcasts"
    restart: unless-stopped

  docker-socket-proxy:
    image: tecnativa/docker-socket-proxy
    container_name: docker-socket-proxy
    restart: unless-stopped
    environment:
      - CONTAINERS=1     # /containers/*
      - IMAGES=1         # /images/*
      - POST=1           # operaciones POST (start/stop, etc.)
      - INFO=1           # /info (por si Homarr lo usa)
      - SYSTEM=1         # /system/* (stats globales, df, etc.)
      # - NETWORKS=1     # solo si algún día lo necesitas
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    expose:
      - "2375"
    healthcheck:
      test: ["CMD", "wget", "-qO", "-", "http://localhost:2375/_ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  organizr:
    image: ghcr.io/organizr/organizr:latest
    container_name: organizr
    ports:
      - "33102:80"
    environment:
      - TZ=Europe/Madrid
      - PUID=1000
      - PGID=1000
      - branch=v2-master
    volumes:
      - "E:/Docker_folders/organizr/organizr_config:/config"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost/ > /dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s

  # --- KOMETA (ex Plex-Meta-Manager) ---------------------------------------
  kometa:
    image: lscr.io/linuxserver/kometa:latest
    container_name: kometa
    restart: unless-stopped
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Madrid
      - KOMETA_CONFIG=/config/config.yml
      - KOMETA_TIME=05:00
    volumes:
      - "E:/Docker_folders/kometa/kometa_config:/config"

  # --- CALIBRE-WEB (frontend para Calibre) ---------------------------------
  calibre-web:
    image: lscr.io/linuxserver/calibre-web:latest
    container_name: calibre-web
    restart: unless-stopped
    ports:
      - "8083:8083"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Madrid
    volumes:
      - "E:/Docker_folders/calibre_web/calibre_web_config:/config"
      - "F:/Libros:/books"

  # --- NAVIDROME (servidor de música) --------------------------------------
  navidrome:
    image: deluan/navidrome:latest
    container_name: navidrome
    restart: unless-stopped
    ports:
      - "4533:4533"
    environment:
      - TZ=Europe/Madrid
      - ND_LOGLEVEL=info
      - ND_SCANSCHEDULE=1h
    volumes:
      - "E:/Docker_folders/navidrome/navidrome_data:/data"
      - "F:/Musica:/music:ro"

  # --- OPEN WEBUI (UI para Ollama/LLMs) ------------------------------------
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    restart: unless-stopped
    ports:
      - "3002:8080"
    environment:
      - OLLAMA_BASE_URL=http://host.docker.internal:11000
      - WEBUI_NAME=OpenWebUI
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - "E:/Docker_folders/openwebui/openwebui_data:/app/backend/data"

  # --- Explorador de carpetas compartidas ----------------------------------
  filebrowser:
    image: filebrowser/filebrowser:latest
    container_name: filebrowser
    environment:
      - TZ=Europe/Madrid
    volumes:
      - "F:/Peliculas:/srv/Peliculas:ro"
      - "E:/Compartida:/srv/Compartida:rw"
      - "E:/Docker_folders/filebrowser/filebrowser_data:/database"
    ports:
      - "18080:80"
    restart: unless-stopped

  # --- Servicio DNS duckDNS ------------------------------------------------
  duckdns:
    image: lscr.io/linuxserver/duckdns:latest
    container_name: duckdns
    environment:
      - SUBDOMAINS=maripiflix
      - TOKEN=453c480f-666f-42b0-96a3-e1f2ab1f7048
    restart: unless-stopped

  kali:
    build: ./kali/kali-custom
    container_name: kali
    hostname: kali
    tty: true
    stdin_open: true
    privileged: true
    gpus: all
    environment:
      - DISPLAY=${DISPLAY:-host.docker.internal:0.0}
      - DOCKER_HOST=${DOCKER_HOST:-unix:///var/run/docker.sock}
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility,graphics
    volumes:
      - "E:/Docker_folders/kali:/home/kali"
      - ./kali/entrypoint_kali.sh:/entrypoint_kali.sh
      - ./kali/kali_scripts:/custom_scripts
      - ./kali/id_rsa_n8n_kali.pub:/root/.ssh/authorized_keys
      - "/sys/fs/cgroup:/sys/fs/cgroup:rw"
      - /var/run/docker.sock:/var/run/docker.sock
    entrypoint: ["/bin/bash", "/entrypoint_kali.sh"]
    ports:
      - "38081:80"
      - "44443:443"
      - "22222:22"
    restart: unless-stopped

  py-runner:
    build:
      context: ./python_scripts
      dockerfile: Dockerfile
    container_name: py-runner
    environment:
      - TZ=Europe/Madrid
      - SUPERVISOR_USER=admin
      - SUPERVISOR_PASSWORD=admin
      - SCRIPTS_DIR=/workspace/scripts
      - LOGS_DIR=/workspace/logs
      - REQUIREMENTS_FILE=/workspace/requirements.txt
      - CRON_FILE=/workspace/schedule.cron
      - AUTO_REGISTER_INTERVAL=5   # opcional (segundos)
    ports:
      - "9012:9001"   # UI web de Supervisor
      - "9013:9001"   # Supervisor (backend)
      - "9014:8000"   # UI moderno (FastAPI)
    volumes:
      - "E:/Docker_folders/python_scripts:/workspace"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9001 >/dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s

  kanboard:
    image: kanboard/kanboard:v1.2.45
    container_name: kanboard
    ports:
      - "8811:80"          # UI web Kanboard -> http://HOST:8811
      # - "8443:443"       # (opcional) si algún día configuras SSL dentro del contenedor
    environment:
      - TZ=Europe/Madrid
      - PLUGIN_INSTALLER=true    # permite instalar plugins desde la interfaz
    volumes:
      - "E:/Docker_folders/kanboard/data:/var/www/app/data"
      - "E:/Docker_folders/kanboard/plugins:/var/www/app/plugins"
      - "E:/Docker_folders/kanboard/ssl:/etc/nginx/ssl"
    restart: unless-stopped

  autobrr:
    image: ghcr.io/autobrr/autobrr:latest
    container_name: autobrr
    ports:
      - "7474:7474"
    environment:
      - TZ=Europe/Madrid
    volumes:
      - "E:/Docker_folders/autoborr/autobrr_config:/config"
    restart: unless-stopped

  emulerr:
    image: isc30/emulerr:latest
    container_name: emulerr
    restart: unless-stopped
    tty: true
    environment:
      - TZ=Europe/Madrid
      - PASSWORD=admin
      - LOG_LEVEL=debug
    ports:
      - "39000:3000"          # UI eMulerr
      - "39062:39062/tcp"     # eD2K TCP
      - "39062:39062/udp"     # Kad/Cliente UDP 
      - "39065:39065/udp"     # Server UDP
      - "39011:39011/tcp"     # amuleweb 
      - "39012:39012/tcp"     # EC/Remote 
    volumes:
      - "D:/Descargas/eMule:/downloads"
      - "./emulerr-amule:/home/amule/.aMule"
      # - "./emulerr-amule/server.met:/config/amule/server.met"
      # - "./emulerr-amule/amule.overrides.conf:/config/amule/amule.overrides.conf"


  # --------------------------------------------------------
  # --- pihole
  # --- DNS sinkhole / adblock
  # --- Ports: 8090 (Gui Web)
  # --------------------------------------------------------
  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    hostname: pihole
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "8090:80"          # Panel web (NPM ya usa 80/443)
    environment:
      - TZ=Europe/Madrid
      - WEBPASSWORD=${PIHOLE_WEBPASSWORD:-admin}   # cámbialo en .env
      - DNSMASQ_LISTENING=all
      # Si usas Unbound, configúralo luego en la UI a 127.0.0.1#5335
    volumes:
      - "E:/Docker_folders/pihole/etc-pihole:/etc/pihole"
      - "E:/Docker_folders/pihole/dnsmasq.d:/etc/dnsmasq.d"
    restart: unless-stopped

  # --------------------------------------------------------
  # --- amule
  # --- Cliente eD2k/Kad (aMule) con Web UI
  # --- Ports: 4711 (Gui Web)
  # --------------------------------------------------------
  amule:
    image: ngosang/amule:latest
    container_name: amule
    environment:
      - TZ=Europe/Madrid
      - PUID=1000
      - PGID=1000
      # contraseñas gestionadas en .env
      - GUI_PWD=${AMULE_GUI_PWD}
      - WEBUI_PWD=${AMULE_WEBUI_PWD}

      # opcional: reinicio diario del contenedor (no imprescindible)
      - MOD_AUTO_RESTART_ENABLED=true
      - MOD_AUTO_RESTART_CRON=0 6 * * *
      - MOD_AUTO_SHARE_ENABLED=false

      - MOD_FIX_KAD_GRAPH_ENABLED=true
      - MOD_FIX_KAD_BOOTSTRAP_ENABLED=true
    ports:
      # UI web y control sólo local
      - "127.0.0.1:4711:4711/tcp"
      - "127.0.0.1:4712:4712/tcp"
      # puertos P2P permanecen abiertos para la red eD2k/Kad
      - "4662:4662/tcp"
      - "4665:4665/udp"
      - "4672:4672/udp"
    volumes:
      - "E:/Docker_folders/amule/config:/home/amule/.aMule"
      - "E:/Docker_folders/amule/incoming:/incoming"
      - "E:/Docker_folders/amule/temp:/temp"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "(command -v wget >/dev/null 2>&1 && wget -qO- http://localhost:4711/ >/dev/null 2>&1) || (command -v curl >/dev/null 2>&1 && curl -fsS http://localhost:4711/ >/dev/null) || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 60s


  # --------------------------------------------------------
  # --- amarr
  # --- Bridge/endpoint para aMule (Torznab/cliente simulado)
  # --- Ports: 33120 (Gui Web)
  # --------------------------------------------------------
  amarr:
    image: vexdev/amarr:latest
    container_name: amarr
    depends_on:
      - amule
    ports:
      - "127.0.0.1:33120:8080"   # UI/endpoint Torznab y cliente simulado
    environment:
      - AMULE_HOST=amule
      - AMULE_PORT=4712
      # reutiliza la misma clave que aMule, gestionada en .env
      - AMULE_PASSWORD=${AMULE_PASSWORD}
      - AMARR_LOG_LEVEL=INFO
      - AMULE_FINISHED_PATH=/incoming
    volumes:
      - "E:/Docker_folders/amarr:/config"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "(command -v wget >/dev/null 2>&1 && wget -qO- http://localhost:8080/ >/dev/null 2>&1) || (command -v curl >/dev/null 2>&1 && curl -fsS http://localhost:8080/ >/dev/null) || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s

  tor-browser:
    image: domistyle/tor-browser:latest
    container_name: tor-browser
    restart: unless-stopped
    shm_size: "2gb"
    ports:
      - "127.0.0.1:33164:5800"
    environment:
      - TZ=Europe/Madrid
    volumes:
      - "D:/Descargas/TorBrowser:/storage/Descargas:rw"

  gluetun-swt:
    image: qmcgaw/gluetun:latest
    container_name: gluetun-swt
    cap_add:
      - NET_ADMIN
    environment:
      - TZ=Europe/Madrid
      - VPN_SERVICE_PROVIDER=mullvad
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY_FIN}
      - WIREGUARD_ADDRESSES=${WIREGUARD_ADDRESSES_FIN}
      - DNS_ADDRESS=${DNS_ADDRESS_FIN}
      - SERVER_COUNTRIES=Finland
      - SERVER_CITIES=Helsinki
      - FIREWALL_INPUT_PORTS=9191,5800,5801,34400
      - FIREWALL_OUTBOUND_SUBNETS=192.168.1.113/32
      # (Opcional) para depurar iptables si hace falta
      # - FIREWALL_DEBUG=on
    ports:
      - "5800:5800"
      - "5801:5801"
      - "9191:9191"
      - "34400:34400"
      # (recomendaciÃ³n hardening) si solo lo quieres local:
      # - "127.0.0.1:34400:34400"
    restart: unless-stopped


    # --------------------------------------------------------
  # --- firefox
  # --- Navegador con GUI web (noVNC)
  # --- Ports: Gluetun 5800
  # --------------------------------------------------------
  firefox:
    image: jlesage/firefox:latest
    container_name: firefox
    network_mode: service:gluetun-vpn-stable
    environment:
      - TZ=Europe/Madrid
      - WEB_LISTENING_PORT=5800
      - VNC_LISTENING_PORT=5900
    volumes:
      - E:/Docker_folders/firefox:/config:rw
      - D:/Descargas/FirefoxVPN:/storage/Descargas:rw
    depends_on:
      - gluetun-vpn-stable
    restart: unless-stopped
    labels:
      - "autoheal=true"
    healthcheck:
      test: ["CMD-SHELL", "(command -v wget >/dev/null 2>&1 && wget -qO- http://127.0.0.1:5800/ >/dev/null 2>&1) || (command -v curl >/dev/null 2>&1 && curl -fsS http://127.0.0.1:5800/ >/dev/null) || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 90s

  # --------------------------------------------------------
  # --- Tor Browser
  # --- Navegador TOR con GUI web (noVNC)
  # --- Ports: Gluetun 5801
  # --------------------------------------------------------
  tor-browser2:
      image: domistyle/tor-browser:latest
      container_name: tor-browser
      network_mode: service:gluetun-vpn-stable
      environment:
        - TZ=Europe/Madrid
        - WEB_LISTENING_PORT=5801
        - VNC_LISTENING_PORT=5901
      volumes:
        - D:/Descargas/TorBrowserVPN:/storage/Descargas:rw
      depends_on:
        - gluetun-vpn-stable
      restart: unless-stopped
      labels:
        - "autoheal=true"
      healthcheck:
        test: ["CMD-SHELL", "(command -v wget >/dev/null 2>&1 && wget -qO- http://127.0.0.1:5801/ >/dev/null 2>&1) || (command -v curl >/dev/null 2>&1 && curl -fsS http://127.0.0.1:5801/ >/dev/null) || exit 1"]
        interval: 30s
        timeout: 5s
        retries: 5
        start_period: 120s
 # --------------------------------------------------------
  # --- dispatcharr
  # --- Gestor/servicio IPTV (bajo VPN gluetun)
  # --- Ports: N/A
  # --------------------------------------------------------
  dispatcharr:
    image: ghcr.io/dispatcharr/dispatcharr:latest
    container_name: dispatcharr
    network_mode: "service:gluetun-vpn-stable"
    environment:
      - TZ=Europe/Madrid
      - DISPATCHARR_ENV=aio
      - DISPATCHARR_LOG_LEVEL=info
    volumes:
      - "E:/Docker_folders/dispatcharr/data:/data"
      - "E:/Docker_folders/dispatcharr/iptv:/data/m3us"
      - "E:/Docker_folders/epg:/data/epgs:ro"
    restart: unless-stopped

  dispatcharr-speedtest:
    image: ghcr.io/dispatcharr/dispatcharr:latest
    container_name: dispatcharr-speedtest
    network_mode: "service:gluetun-mullvad-speedtest"
    depends_on:
      - gluetun-mullvad-speedtest
    environment:
      - TZ=Europe/Madrid
      - DISPATCHARR_ENV=aio
      - DISPATCHARR_LOG_LEVEL=info
    volumes:
      - "E:/Docker_folders/dispatcharr-test/data:/data"
      - "E:/Docker_folders/dispatcharr/iptv:/data/m3us"
      - "E:/Docker_folders/epg:/data/epgs:ro"
    restart: unless-stopped

  gluetun-mullvad-speedtest:
    image: qmcgaw/gluetun:v3.41.0
    container_name: gluetun-mullvad-speedtest
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - "E:/Docker_folders/gluetun-mullvad-speedtest/work-wg0.conf:/gluetun/wireguard/wg0.conf:ro"
    ports:
      - "127.0.0.1:9197:9191/tcp"   # UI/API Dispatcharr TEST
      - "127.0.0.1:9198:9999/tcp"   # health debug (opcional)
      - "127.0.0.1:9199:8000/tcp"
    environment:
      - TZ=Europe/Madrid
      - VPN_SERVICE_PROVIDER=custom
      - VPN_TYPE=wireguard
      # Mantén lo tuyo si lo necesitas (LAN access etc.)
      - FIREWALL_OUTBOUND_SUBNETS=192.168.0.0/16,172.16.0.0/12
      # Recomendado por defecto (v3.41.0 ya lo trae bien)
      - HEALTH_RESTART_VPN=on
      - HEALTH_TARGET_ADDRESSES=cloudflare.com:443,github.com:443
      - HEALTH_ICMP_TARGET_IPS=1.1.1.1,8.8.8.8
      - HTTP_CONTROL_SERVER_ADDRESS=:8000
      - HTTP_CONTROL_SERVER_AUTH_DEFAULT_ROLE={"auth":"apikey","apikey":"${GLUETUN_CONTROL_APIKEY}"}
      - FIREWALL_INPUT_PORTS=9191,9999,8000
    restart: unless-stopped


  gluetun-vpn-stable:
    image: qmcgaw/gluetun:v3.41.0
    container_name: gluetun-vpn-stable
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - "E:/Docker_folders/gluetun-vpn-stable/work-wg0.conf:/gluetun/wireguard/wg0.conf:ro"
    environment:
      - TZ=Europe/Madrid
      - VPN_SERVICE_PROVIDER=custom
      - VPN_TYPE=wireguard
      # Healthcheck / auto healing del VPN (no reinicies contenedor si no hace falta)
      - HEALTH_RESTART_VPN=on
      - HEALTH_TARGET_ADDRESSES=cloudflare.com:443,github.com:443
      - HEALTH_ICMP_TARGET_IPS=1.1.1.1,8.8.8.8
      # Health server visible (si quieres debug desde host); por defecto es 127.0.0.1:9999
      - HEALTH_SERVER_ADDRESS=:9999
      # Control Server (para start/stop VPN sin restart del contenedor) :contentReference[oaicite:6]{index=6}
      - HTTP_CONTROL_SERVER_ADDRESS=:8000
      # IMPORTANTE: desde v3.40.0 las rutas pasan a “privadas” por defecto, usa rol por defecto :contentReference[oaicite:7]{index=7}
      - HTTP_CONTROL_SERVER_AUTH_DEFAULT_ROLE={"auth":"apikey","apikey":"${GLUETUN_CONTROL_APIKEY}"}
      # Firewall: SOLO puertos internos reales (no metas los host ports)
      # dispatcharr 9191, firefox 5800, tor 5801, health 9999, control 8000 :contentReference[oaicite:8]{index=8}
      - FIREWALL_INPUT_PORTS=9191,5800,5801,9999,8000
      # Acceso LAN
      - FIREWALL_OUTBOUND_SUBNETS=192.168.0.0/16,172.16.0.0/12
      # Si usas DOT/DoH etc, deja tu config
      - DOT=off
      - LOG_LEVEL=info
    ports:
      - "9191:9191/tcp"        # dispatcharr
      - "5800:5800/tcp"        # firefox
      - "5801:5801/tcp"        # tor
      - "127.0.0.1:9192:9999/tcp"  # health debug
      - "127.0.0.1:9193:8000/tcp"  # control debug
    restart: unless-stopped

  gluetun-stable-keeper:
    build:
      context: ./gluetun-stable-keeper
      dockerfile: Dockerfile
    container_name: gluetun-stable-keeper
    user: "0:0"
    environment:
      - LOG_LEVEL=INFO
      - CONFS_DIR=/mullvad-confs
      - TOP10_JSON=/speedtest/top10_streaming.json
      - STABLE_WG0=/stable/work-wg0.conf
      - STATE_PATH=/stable/stable_keeper_state.json
      - DEFAULT_SERVER=fi-hel-wg-001
      - GLUETUN_CONTAINER=gluetun-vpn-stable
      - CONTROL_BASE_URL=http://gluetun-vpn-stable:8000
      - CONTROL_APIKEY=${GLUETUN_CONTROL_APIKEY}
      - CHECK_INTERVAL_S=20
      - UNHEALTHY_GRACE_S=120
      - CONNECT_TIMEOUT_S=180
      - MAX_ATTEMPTS_PER_SERVER=3
      - MIN_SWITCH_INTERVAL_S=600
      - RANDOM_ON_EXHAUST=true
      - PREFER_BEST_WHEN_HEALTHY=false
    volumes:
      - "E:/Docker_folders/_mullvadvpn-servers:/mullvad-confs:ro"
      - "E:/Docker_folders/gluetun-mullvad-speedtest:/speedtest:ro"
      - "E:/Docker_folders/gluetun-vpn-stable:/stable"
      - "/var/run/docker.sock:/var/run/docker.sock"
    restart: unless-stopped

  mullvad-conf-sweeper:
    build:
      context: ./gluetun-stable-keeper
      dockerfile: Dockerfile
    container_name: mullvad-conf-sweeper
    command: ["python","/app/mullvad_conf_sweep.py"]
    user: "0:0"
    environment:
      - LOG_LEVEL=INFO
      - CONFS_DIR=/mullvad-confs
      - WORK_WG0=/speedtest/work-wg0.conf
      - DB_PATH=/speedtest/sweep.sqlite3
      - JSONL_PATH=/speedtest/results.jsonl
      - TOP10_JSON=/speedtest/top10_streaming.json

      - SPEEDTEST_GLUETUN_CONTAINER=gluetun-mullvad-speedtest
      - TESTER_IMAGE=zenomedia-server-gluetun-stable-keeper:latest

      # ✅ NUEVO: M3U del Dispatcharr TEST (lo pondrás en el Paso 6)
      - STREAM_M3U_URL=http://127.0.0.1:9191/output/m3u/REEMPLAZA_ESTO
      - DISPATCHARR_INTERNAL_BASE=http://127.0.0.1:9191
      - REQUIRE_DISPATCHARR_PROXY=true

      # 6 horas
      - MAX_RUNTIME_S=21600

      - STREAM_SECONDS=12
      - STREAM_MAX_TIME=25
      - CONNECT_HEALTH_TIMEOUT_S=180
      - EGRESS_TIMEOUT_S=20
    volumes:
      - "E:/Docker_folders/_mullvadvpn-servers:/mullvad-confs:ro"
      - "E:/Docker_folders/gluetun-mullvad-speedtest:/speedtest"
      - "/var/run/docker.sock:/var/run/docker.sock"
    restart: "no"


# --------------------------------------------------------
  # --- moverpelis
  # --- Script de utilidades: mover archivos descargados
  # --- Ports: N/A
  # --------------------------------------------------------
  moverpelis:
    image: alpine:3.20
    container_name: moverpelis
    command: >
      sh -c 'apk add --no-cache findutils coreutils >/dev/null
      && echo "$(date "+%F %T.%3N") | Monitoreando /watch -> /target (cada 15s, mueve archivos con >1 min sin cambios)..."
      && while :; do
           /usr/bin/find /watch -maxdepth 1 -type f -mmin +1 \
             -exec mv -n -t /target {} +
           sleep 15
         done'
    volumes:
      - "D:/Descargas/eMule/Incoming/pelis:/watch"
      - "E:/Peliculas:/target"
    restart: unless-stopped