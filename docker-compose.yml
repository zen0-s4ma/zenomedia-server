# ZENOMEDIA SERVER V0.1
volumes:
  romm_db_data:

services:
  # --- JELLYFIN -------------------------------------------------------------
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    ports:
      - "8096:8096"
      - "8920:8920"
      - "7359:7359/udp"
    environment:
      TZ: Europe/Madrid
      UMASK: "022"
      JELLYFIN_PublishedServerUrl: "${JELLYFIN_PUBLISHED_URL}"
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: compute,video,utility
      LOG_LEVEL: debug
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    volumes:
      # CONFIG
      # Carpeta completa del cliente web
      - "E:/Docker_folders/jellifyn/jellyfin-web:/jellyfin/jellyfin-web"
      # Logos extra para CSS
      - "E:/Docker_folders/jellifyn/custom-logos:/jellyfin/jellyfin-web/custom-logos:ro"
      # UNIDAD DE ALMACENAMIENTO F (CONTENIDO MULTIMEDIA):
      - "F:/Peliculas:/media/Peliculas"
      - "F:/Documentales:/media/Documentales"
      - "F:/Series:/media/Series"
      - "F:/MiniSeries:/media/MiniSeries"
      - "F:/Anime:/media/Anime"
      - "F:/Futbol:/media/Futbol"
      - "F:/Baloncesto:/media/Baloncesto"
      - "F:/NFL:/media/NFL"
      - "F:/Combates:/media/Combates"
      - "F:/LoL:/media/LoL"
      - "F:/Olimpiadas:/media/Olimpiadas"
      # UNIDAD DE ALMACENAMIENTO E (CONTENIDO MULTIMEDIA):
      - "E:/Peliculas:/media/Peliculas2"
      - "E:/Series:/media/Series2"
      - "E:/MiniSeries:/media/MiniSeries2"
      - "E:/YouTube:/media/YouTube2"
      - "E:/Anime:/media/Anime2"
      - "E:/Documentales:/media/Documentales2"
      - "E:/Futbol:/media/Futbol2"
      - "E:/Baloncesto:/media/Baloncesto2"
      - "E:/NFL:/media/NFL2"
      - "E:/Combates:/media/Combates2"
      - "E:/LoL:/media/LoL2"
      - "E:/Olimpiadas:/media/Olimpiadas2"
      # PATHS DE CONFIGURACION E:
      - "E:/Docker_folders/jellifyn/metadata:/config"
      - "E:/Docker_folders/jellifyn/cache:/cache"
      - "E:/Docker_folders/jellifyn/transcodes:/transcode"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8096/health"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 60s

  jellyfin-old:
    image: jellyfin/jellyfin:10.10.7
    container_name: jellyfin-old
    ports:
      - "8096:8096"
      - "8920:8920"
      - "7359:7359/udp"
    environment:
      TZ: Europe/Madrid
      UMASK: "022"
      JELLYFIN_PublishedServerUrl: "${JELLYFIN_PUBLISHED_URL}"
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: compute,video,utility
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    volumes:
      # CONFIG
      #
      # ---
      #
      # UNIDAD DE ALMACENAMIENTO F (CONTENIDO MULTIMEDIA):
      - "F:/Peliculas:/media/Peliculas"
      - "F:/Documentales:/media/Documentales"
      - "F:/Series:/media/Series"
      - "F:/MiniSeries:/media/MiniSeries"
      - "F:/Anime:/media/Anime"
      - "F:/Futbol:/media/Futbol"
      - "F:/Baloncesto:/media/Baloncesto"
      - "F:/NFL:/media/NFL"
      - "F:/Combates:/media/Combates"
      - "F:/LoL:/media/LoL"
      - "F:/Olimpiadas:/media/Olimpiadas"
      # UNIDAD DE ALMACENAMIENTO E (CONTENIDO MULTIMEDIA):
      - "E:/Peliculas:/media/Peliculas2"
      - "E:/Series:/media/Series2"
      - "E:/MiniSeries:/media/MiniSeries2"
      - "E:/YouTube:/media/YouTube2"
      - "E:/Anime:/media/Anime2"
      - "E:/Documentales:/media/Documentales2"
      - "E:/Futbol:/media/Futbol2"
      - "E:/Baloncesto:/media/Baloncesto2"
      - "E:/NFL:/media/NFL2"
      - "E:/Combates:/media/Combates2"
      - "E:/LoL:/media/LoL2"
      - "E:/Olimpiadas:/media/Olimpiadas2"
      # PATHS DE CONFIGURACION E:
      - "E:/Docker_folders/jellifyn-old/metadata:/config"
      - "E:/Docker_folders/jellifyn-old/cache:/cache"
      - "E:/Docker_folders/jellifyn-old/transcodes:/transcode"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8096/health"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 60s

  # --- TUBEARCHIVIST (UI :8000) --------------------------------------------
  tubearchivist:
    image: bbilly1/tubearchivist:latest
    container_name: tubearchivist
    depends_on:
      - archivist-es
      - archivist-redis
    ports:
      - "8001:8000"
    environment:
      TZ: Europe/Madrid
      TA_HOST: "${TA_HOSTS}"
      TA_USERNAME: "${TA_USERNAME}"
      TA_PASSWORD: "${TA_PASSWORD}"
      ES_URL: "http://archivist-es:9200"
      REDIS_CON: "redis://archivist-redis:6379"
      ELASTIC_PASSWORD: "${TA_ES_PASSWORD}"
      HOST_UID: "1000"
      HOST_GID: "1000"
    volumes:
      - "E:/Docker_folders/TubeArchivist/media:/youtube"
      - "E:/Docker_folders/TubeArchivist/cache:/cache"
    restart: unless-stopped
    healthcheck:
      # dentro del contenedor es 8000, no 8001
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health >/dev/null"]
      interval: 2m
      timeout: 10s
      retries: 3
      start_period: 30s

  archivist-redis:
    image: redis/redis-stack-server:latest
    container_name: archivist-redis
    expose: ["6379"]
    volumes:
      - "E:/Docker_folders/TubeArchivist/redis:/data"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -h 127.0.0.1 -p 6379 ping | grep PONG"]
      interval: 30s
      timeout: 5s
      retries: 5

  archivist-es:
    image: bbilly1/tubearchivist-es:latest
    container_name: archivist-es
    environment:
      - ELASTIC_PASSWORD=${TA_ES_PASSWORD}
      - ES_JAVA_OPTS=-Xms512m -Xmx1g
      - discovery.type=single-node
      - xpack.security.enabled=true
      - ES_SETTING_PATH_REPO=/usr/share/elasticsearch/data/snapshot
    expose: ["9200"]
    volumes:
      - "E:/Docker_folders/TubeArchivist/ElasticSearch:/usr/share/elasticsearch/data"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS -u elastic:${TA_ES_PASSWORD} http://localhost:9200 >/dev/null"]
      interval: 30s
      timeout: 5s
      retries: 10
      start_period: 60s

  # --- Gestión de usuarios Jellyfin ----------------------------------------
  jfa-go:
    image: hrfee/jfa-go:latest
    container_name: jfa-go
    depends_on: [jellyfin]
    ports: ["8056:8056"]
    environment:
      - TZ=Europe/Madrid
      - JELLYFIN_URL=http://jellyfin:8096
    volumes:
      - "E:/Docker_folders/jfa-go:/data"
      - "E:/Docker_folders/metadata:/jf:ro"
    restart: unless-stopped

  # --- Estadísticas avanzadas ----------------------------------------------
  jellystat:
    image: cyfershepard/jellystat:latest
    container_name: jellystat
    depends_on:
      jellystat-db:
        condition: service_healthy
    ports: ["3000:3000"]
    environment:
      - TZ=Europe/Madrid
      - POSTGRES_IP=jellystat-db
      - POSTGRES_PORT=5432
      - POSTGRES_DB=jellystat
      - POSTGRES_USER=jellystat
      - POSTGRES_PASSWORD=${JELLYSTAT_DB_PASS}
      - JWT_SECRET=${JELLYSTAT_JWT}
      - JELLYFIN_URL=http://jellyfin:8096
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:3000 >/dev/null"]
      interval: 1m
      timeout: 5s
      retries: 3
      start_period: 20s

  jellystat-db:
    image: postgres:16
    container_name: jellystat-db
    environment:
      - POSTGRES_DB=jellystat
      - POSTGRES_USER=jellystat
      - POSTGRES_PASSWORD=${JELLYSTAT_DB_PASS}
    volumes:
      - "E:/Docker_folders/jellystat/postgres:/var/lib/postgresql/data"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U jellystat -d jellystat -h 127.0.0.1 -p 5432"]
      interval: 30s
      timeout: 5s
      retries: 5
 
  # --- IPTV proxy (xTeVe moderno) ------------------------------------------
  threadfin:
    image: fyb3roptik/threadfin:latest
    container_name: threadfin
    ports: ["34400:34400"]
    environment:
      - TZ=Europe/Madrid
    volumes:
      - "E:/Docker_folders/threadfin:/home/threadfin/.threadfin"
    restart: unless-stopped

  # --- Backend PVR completo (timeshift/DVR) --------------------------------
  tvheadend:
    image: lscr.io/linuxserver/tvheadend:latest
    container_name: tvheadend
    ports:
      - "9981:9981"
      - "9982:9982"
    environment:
      - TZ=Europe/Madrid
      - PUID=1000
      - PGID=1000
    volumes:
      - "E:/Docker_folders/tvheadend/config:/config"
      - "E:/Docker_folders/tvheadend/recordings:/recordings"
    restart: unless-stopped

  heimdall:
    image: linuxserver/heimdall
    container_name: heimdall_dashboard
    restart: unless-stopped
    ports:
      - "7771:80"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Madrid
    volumes:
      - "E:/Docker_folders/heimdall:/config"

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    ports:
      - "8080:8080"
      - "6881:6881"
      - "6881:6881/udp"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Madrid
      - WEBUI_PORT=8080
      - TORRENTING_PORT=6881
    volumes:
      - "E:/Docker_folders/qbittorrent/qbittorrent_data:/config"
      - "E:/Docker_folders/qbittorrent/media_data:/downloads"
    restart: unless-stopped

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    ports:
      - "33074:8989"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Madrid
    volumes:
      - "E:/Docker_folders/sonarr/sonarr_data:/config"
      - "E:/Docker_folders/sonarr/media_data:/downloads"
      - "F:/Series:/tv"
    restart: unless-stopped

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    ports:
      - "33075:7878"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Madrid
    volumes:
      - "E:/Docker_folders/radarr/radarr_data:/config"
      - "E:/Docker_folders/radarr/media_data:/downloads"
      - "F:/Peliculas:/movies"
    restart: unless-stopped

  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    ports:
      - "33076:6767"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Madrid
    volumes:
      - "E:/Docker_folders/bazarr/bazarr_data:/config"
      - "E:/Docker_folders/bazarr/media_data:/downloads"
      - "F:/Peliculas:/movies:ro"
      - "F:/Series:/tv:ro"
    restart: unless-stopped

  lidarr:
    image: lscr.io/linuxserver/lidarr:latest
    container_name: lidarr
    ports:
      - "33077:8686"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Madrid
    volumes:
      - "E:/Docker_folders/lidarr/lidarr_data:/config"
      - "E:/Docker_folders/lidarr/media_data:/downloads"
    restart: unless-stopped

  readarr:
    image: ghcr.io/hotio/readarr:latest
    container_name: readarr
    ports:
      - "33078:8787"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Madrid
    volumes:
      - "E:/Docker_folders/readarr/readarr_data:/config"
      - "E:/Docker_folders/readarr/descargas:/downloads"
      - "F:/Libros:/books"
    restart: unless-stopped

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    ports:
      - "33079:9696"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Madrid
    volumes:
      - "E:/Docker_folders/prowlarr/prowlarr_data:/config"
    restart: unless-stopped

  jellyseerr:
    image: fallenbagel/jellyseerr:latest
    container_name: jellyseerr
    ports: ["33080:5055"]
    environment:
      - TZ=Europe/Madrid
      - LOG_LEVEL=info
    volumes:
      - "E:/Docker_folders/jellyseerr/jellyseerr_data:/app/config"
      - "E:/Docker_folders/jellyseerr/raiz:/raiz"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:5055/api/v1/status >/dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s

  # --- TDARR ---------------------------------------------------------------
  tdarr:
    image: ghcr.io/haveagitgat/tdarr:latest
    container_name: tdarr
    ports:
      - "33081:8265"
      - "33082:8266"
    environment:
      - TZ=Europe/Madrid
      - PUID=1000
      - PGID=1000
      - UMASK_SET=002
      - serverIP=0.0.0.0
      - serverPort=8266
      - webUIPort=8265
      - internalNode=true
      - inContainer=true
      - ffmpegVersion=7
      - nodeName=InternalNode
      - auth=false
      - NVIDIA_DRIVER_CAPABILITIES=all
      - NVIDIA_VISIBLE_DEVICES=all
    volumes:
      - "E:/Docker_folders/tdarr/tdarr_server:/app/server"
      - "E:/Docker_folders/tdarr/tdarr_configs:/app/configs"
      - "E:/Docker_folders/tdarr/tdarr_logs:/app/logs"
      - "E:/Docker_folders/tdarr/media_data:/media"
      - "E:/Docker_folders/tdarr/tdarr_cache:/temp"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    restart: unless-stopped

  # --- KOMGA ---------------------------------------------------------------
  komga:
    image: gotson/komga:latest
    container_name: komga
    ports: ["33083:25600"]
    environment:
      - TZ=Europe/Madrid
    volumes:
      - "E:/Docker_folders/komga/komga_config:/config"
      - "E:/Docker_folders/komga/komga_data:/data"
    restart: unless-stopped

  # --- CALIBRE -------------------------------------------------------------
  calibre:
    image: lscr.io/linuxserver/calibre:latest
    container_name: calibre
    ports:
      - "33084:8080"
      - "33085:8181"
      - "33087:8081"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Madrid
    volumes:
      - "E:/Docker_folders/calibre/calibre_config:/config"
    restart: unless-stopped

  # --- KAVITA --------------------------------------------------------------
  kavita:
    image: lscr.io/linuxserver/kavita:latest
    container_name: kavita
    ports: ["33086:5000"]
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Madrid
    volumes:
      - "E:/Docker_folders/kavita/kavita_config:/config"
      - "E:/Docker_folders/kavita/kavita_data:/data"
    restart: unless-stopped

  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    ports:
      - "9443:9443"
      - "8000:8000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - "E:/Docker_folders/portainer/portainer_data:/data"
    restart: unless-stopped

  dozzle:
    image: amir20/dozzle:latest
    container_name: dozzle
    ports:
      - "9999:8080"
    environment:
      - TZ=Europe/Madrid
      - DOZZLE_LEVEL=info
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped

  netdata:
    image: netdata/netdata:stable
    container_name: netdata
    hostname: netdata
    ports:
      - "19999:19999"
    cap_add:
      - SYS_PTRACE
    security_opt:
      - apparmor:unconfined
    environment:
      - TZ=Europe/Madrid
    volumes:
      - "E:/Docker_folders/netdata/netdata_config:/etc/netdata"
      - "E:/Docker_folders/netdata/netdata_lib:/var/lib/netdata"
      - "E:/Docker_folders/netdata/netdata_cache:/var/cache/netdata"
      - /etc/passwd:/host/etc/passwd:ro
      - /etc/group:/host/etc/group:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /etc/os-release:/host/etc/os-release:ro
    restart: unless-stopped

  audiobookshelf:
    image: ghcr.io/advplyr/audiobookshelf:latest
    container_name: audiobookshelf
    ports:
      - "13378:80"
    environment:
      - TZ=Europe/Madrid
    volumes:
      - "E:/Docker_folders/audiobookshelf/audiobookshelf_config:/config"
      - "E:/Docker_folders/audiobookshelf/audiobookshelf_metadata:/metadata"
      - "F:/Audiolibros:/audiobooks"
      - "F:/Podcasts:/podcasts"
    restart: unless-stopped

  unmanic:
    image: josh5/unmanic:latest
    container_name: unmanic
    ports:
      - "8888:8888"
    environment:
      - TZ=Europe/Madrid
      - PUID=1000
      - PGID=1000
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
    volumes:
      - "E:/Docker_folders/unmanic/unmanic_config:/config"
      - "E:/Docker_folders/unmanic/media_data:/watch"
      - "F:/_Multimedia:/library"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu,video,utility]
    restart: unless-stopped

  recyclarr:
    image: ghcr.io/recyclarr/recyclarr:latest
    container_name: recyclarr
    environment:
      - TZ=Europe/Madrid
      - CRON_SCHEDULE=0 5 * * *
    volumes:
      - "E:/Docker_folders/recyclarr/recyclarr_config:/config"
    restart: unless-stopped

  autobrr:
    image: ghcr.io/autobrr/autobrr:latest
    container_name: autobrr
    ports:
      - "7474:7474"
    environment:
      - TZ=Europe/Madrid
    volumes:
      - "E:/Docker_folders/autoborr/autobrr_config:/config"
    restart: unless-stopped

  notifiarr:
    image: golift/notifiarr:latest
    container_name: notifiarr
    ports:
      - "5454:5454"
    environment:
      - TZ=Europe/Madrid
      - PUID=1000
      - PGID=1000
    volumes:
      - "E:/Docker_folders/notifiarr/notifiarr_config:/config"
    restart: unless-stopped

  docker-socket-proxy:
    image: tecnativa/docker-socket-proxy
    container_name: docker-socket-proxy
    restart: unless-stopped
    environment:
      - CONTAINERS=1     # /containers/*
      - IMAGES=1         # /images/*
      - POST=1           # operaciones POST (start/stop, etc.)
      - INFO=1           # /info (por si Homarr lo usa)
      - SYSTEM=1         # /system/* (stats globales, df, etc.)
      # - NETWORKS=1     # solo si algún día lo necesitas
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    expose:
      - "2375"
    healthcheck:
      test: ["CMD", "wget", "-qO", "-", "http://localhost:2375/_ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  homarr:
    container_name: homarr
    image: ghcr.io/homarr-labs/homarr:v1.35.1
    restart: unless-stopped
    depends_on:
      docker-socket-proxy:
        condition: service_healthy
    ports:
      - "7575:7575"
    volumes:
      - E:/Docker_folders/homarr/appdata:/appdata
    environment:
      - SECRET_ENCRYPTION_KEY=e111e33c3056a58c37491e24fd3a90b087f906ab1468893544c23205dd10e96b
      - DOCKER_HOSTNAMES=docker-socket-proxy
      - DOCKER_PORTS=2375
      # - LOG_LEVEL=debug

  jackett:
    image: lscr.io/linuxserver/jackett:latest
    container_name: jackett
    ports:
      - "9117:9117"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Madrid
      - AUTO_UPDATE=true
    volumes:
      - "E:/Docker_folders/jackett/jackett_data:/config"
      - "E:/Docker_folders/jackett/media_data:/downloads"
    restart: unless-stopped

  organizr:
    image: ghcr.io/organizr/organizr:latest
    container_name: organizr
    ports:
      - "33102:80"
    environment:
      - TZ=Europe/Madrid
      - PUID=1000
      - PGID=1000
      - branch=v2-master
    volumes:
      - "E:/Docker_folders/organizr/organizr_config:/config"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost/ > /dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s

  cloudbeaver:
    image: dbeaver/cloudbeaver:latest
    container_name: cloudbeaver
    ports:
      - "18978:8978"
    volumes:
      - "E:/Docker_folders/cloudbeaver/cloudbeaver_workspace:/opt/cloudbeaver/workspace"
    restart: unless-stopped

  postgres:
    image: postgres:16-alpine
    container_name: postgres
    hostname: postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - POSTGRES_DB
    volumes:
      - "E:/Docker_folders/postgres/postgres_storage:/var/lib/postgresql/data"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -h 127.0.0.1 -p 5432 -U ${POSTGRES_USER} -d ${POSTGRES_DB}"
        ]
      interval: 20s
      timeout: 10s
      retries: 10
      start_period: 240s

  postgresn8n:
    image: postgres:16-alpine
    container_name: postgresn8n
    hostname: postgresn8n
    restart: unless-stopped
    environment:
      - POSTGRES_N8N_USER
      - POSTGRES_N8N_PASSWORD
      - POSTGRES_N8N_DB
    volumes:
      - "E:/Docker_folders/postgres/postgres_storage:/var/lib/postgresql/data"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -h 127.0.0.1 -p 5432 -U ${POSTGRES_USER} -d ${POSTGRES_DB}"
        ]
      interval: 20s
      timeout: 10s
      retries: 10
      start_period: 240s

  n8n:
    hostname: n8n
    container_name: n8n
    restart: unless-stopped
    image: n8nio/n8n:latest
    environment:
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgresn8n
      - DB_POSTGRESDB_USER=${POSTGRES_N8N_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_N8N_PASSWORD}
      - N8N_RUNNERS_ENABLED=true                # Activa task runners (evita problemas futuros)
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=true       # Más seguro por defecto (ver nota abajo)
      - N8N_GIT_NODE_DISABLE_BARE_REPOS=true    # Desactiva repos bare en Git Node
      - N8N_DIAGNOSTICS_ENABLED=false
      - N8N_PERSONALIZATION_ENABLED=false
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - N8N_USER_MANAGEMENT_JWT_SECRET=${N8N_USER_MANAGEMENT_JWT_SECRET}
      - OLLAMA_HOST=${OLLAMA_HOST:-ollama:11434}
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
    env_file:
      - path: .env
        required: true
    ports:
      - 5678:5678
    volumes:
      - "E:/Docker_folders/n8n/n8n_storage:/home/node/.n8n"
      - "E:/Docker_folders/n8n/n8n/demo-data:/demo-data"
      - "E:/Docker_folders/n8n/shared:/data/shared"
    depends_on:
      postgresn8n:
        condition: service_healthy

  ollama-cpu:
    profiles: ["cpu"]
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    ports:
      - 11000:11434
    volumes:
      - "E:/Docker_folders/ollama:/root/.ollama"

  ollama-gpu:
    profiles: ["gpu-nvidia"]
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    ports:
      - 11000:11434
    volumes:
      - "E:/Docker_folders/ollama:/root/.ollama"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  ollama-gpu-amd:
    profiles: ["gpu-amd"]
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    ports:
      - 11000:11434
    volumes:
      - "E:/Docker_folders/ollama:/root/.ollama"
    devices:
      - "/dev/kfd"
      - "/dev/dri"

  qdrant:
    image: qdrant/qdrant
    hostname: qdrant
    container_name: qdrant
    restart: unless-stopped
    ports:
      - 6333:6333
    volumes:
      - "E:/Docker_folders/qdrant/qdrant_storage:/qdrant/storage"

  searxng:
    image: searxng/searxng:latest
    container_name: searxng
    restart: unless-stopped
    ports:
      - "4080:8080"
    environment:
      - SEARXNG_BASE_URL=http://localhost:4080
      # - SEARXNG_SECRET=CAMBIA_ESTA_CLAVE_LARGA_Y_UNICA
    volumes:
      - "E:/Docker_folders/SearXNG/config:/etc/searxng"
      - "E:/Docker_folders/SearXNG/cache:/var/cache/searxng"

  # --- NGINX PROXY MANAGER (HTTP/HTTPS + Panel) ----------------------------
  nginx-proxy-manager:
    image: jc21/nginx-proxy-manager:latest
    container_name: nginx-proxy-manager
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "81:81"
    environment:
      - TZ=Europe/Madrid
      - INITIAL_ADMIN_EMAIL=admin@admin.com
      - INITIAL_ADMIN_PASSWORD=admin
    volumes:
      - "E:/Docker_folders/nginx/npm_data:/data"
      - "E:/Docker_folders/nginx/npm_letsencrypt:/etc/letsencrypt"

  # --- KOMETA (ex Plex-Meta-Manager) ---------------------------------------
  kometa:
    image: lscr.io/linuxserver/kometa:latest
    container_name: kometa
    restart: unless-stopped
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Madrid
      - KOMETA_CONFIG=/config/config.yml
      - KOMETA_TIME=05:00
    volumes:
      - "E:/Docker_folders/kometa/kometa_config:/config"

  # --- CALIBRE-WEB (frontend para Calibre) ---------------------------------
  calibre-web:
    image: lscr.io/linuxserver/calibre-web:latest
    container_name: calibre-web
    restart: unless-stopped
    ports:
      - "8083:8083"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Madrid
    volumes:
      - "E:/Docker_folders/calibre_web/calibre_web_config:/config"
      - "F:/Libros:/books"

  # --- NAVIDROME (servidor de música) --------------------------------------
  navidrome:
    image: deluan/navidrome:latest
    container_name: navidrome
    restart: unless-stopped
    ports:
      - "4533:4533"
    environment:
      - TZ=Europe/Madrid
      - ND_LOGLEVEL=info
      - ND_SCANSCHEDULE=1h
    volumes:
      - "E:/Docker_folders/navidrome/navidrome_data:/data"
      - "F:/Musica:/music:ro"

  # --- OPEN WEBUI (UI para Ollama/LLMs) ------------------------------------
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    restart: unless-stopped
    ports:
      - "3002:8080"
    environment:
      - OLLAMA_BASE_URL=http://host.docker.internal:11000
      - WEBUI_NAME=OpenWebUI
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - "E:/Docker_folders/openwebui/openwebui_data:/app/backend/data"

  # --- UPTIME KUMA (monitor de servicios) ----------------------------------
  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: uptime-kuma
    restart: unless-stopped
    ports:
      - "3001:3001"
    volumes:
      - "E:/Docker_folders/uptime_kuma/uptime_kuma_data:/app/data"

  # --- RomM (servidor de videojuegos via web) ----------------------------------
  romm-db:
    image: mariadb:11
    container_name: romm-db
    restart: unless-stopped
    environment:
      - MARIADB_ROOT_PASSWORD=${ROMM_DB_ROOT_PASS}
      - MARIADB_DATABASE=romm
      - MARIADB_USER=admin
      - MARIADB_PASSWORD=${ROMM_DB_PASS}
    volumes:
      - romm_db_data:/var/lib/mysql  # <-- volumen nombrado (NO ruta de Windows)
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      start_period: 240s   # antes 30s
      interval: 20s        # antes 10s
      timeout: 10s         # antes 5s
      retries: 10          # antes 5

  romm:
    image: rommapp/romm:latest
    container_name: romm
    restart: unless-stopped
    depends_on:
      romm-db:
        condition: service_healthy
    environment:
      - DB_HOST=romm-db
      - DB_PORT=3306
      - DB_NAME=romm
      - DB_USER=admin                # <-- igual que el creado por MariaDB
      - DB_PASSWD=${ROMM_DB_PASS}    # <-- usa la MISMA pass que MARIADB_PASSWORD en romm-db
      - ROMM_AUTH_SECRET_KEY=${ROMM_AUTH_SECRET_KEY}
      - STEAMGRIDDB_API_KEY=${STEAMGRIDDB_API_KEY}
      - IGDB_CLIENT_ID=${IGDB_CLIENT_ID}
      - IGDB_CLIENT_SECRET=${IGDB_CLIENT_SECRET}
      - SCREENSCRAPER_USER=${SCREENSCRAPER_USER}
      - SCREENSCRAPER_PASSWORD=${SCREENSCRAPER_PASSWORD}
    volumes:
      - "E:/Docker_folders/romm/romm_resources:/romm/resources"
      - "E:/Docker_folders/romm/romm_redis_data:/redis-data"
      - "E:/ROMM/library:/romm/library"
      - "E:/ROMM/assets:/romm/assets"
      - "E:/ROMM/config:/romm/config"
    ports:
      - "33110:8080"

  # --- Mover de emule a pelis ----------------------------------------------
  moverpelis:
    image: alpine:3.20
    container_name: moverpelis
    command: >
      sh -c 'apk add --no-cache findutils coreutils >/dev/null
      && echo "$(date "+%F %T.%3N") | Monitoreando /watch -> /target (cada 15s, mueve archivos con >1 min sin cambios)..."
      && while :; do
           /usr/bin/find /watch -maxdepth 1 -type f -mmin +1 \
             -exec mv -n -t /target {} +
           sleep 15
         done'
    volumes:
      - "D:/Descargas/eMule/Incoming/pelis:/watch"
      - "E:/Peliculas:/target"
    restart: unless-stopped

  # --- Explorador de carpetas compartidas ----------------------------------
  filebrowser:
    image: filebrowser/filebrowser:latest
    container_name: filebrowser
    environment:
      - TZ=Europe/Madrid
    volumes:
      - "F:/Peliculas:/srv/Peliculas:ro"
      - "E:/Compartida:/srv/Compartida:rw"
      - "E:/Docker_folders/filebrowser/filebrowser_data:/database"
    ports:
      - "18080:80"
    restart: unless-stopped

  # --- Servicio DNS duckDNS ------------------------------------------------
  duckdns:
    image: lscr.io/linuxserver/duckdns:latest
    container_name: duckdns
    environment:
      - SUBDOMAINS=maripiflix
      - TOKEN=453c480f-666f-42b0-96a3-e1f2ab1f7048
    restart: unless-stopped


  kali:
    build: ./kali/kali-custom
    container_name: kali
    hostname: kali
    tty: true
    stdin_open: true
    privileged: true
    gpus: all
    environment:
      - DISPLAY=${DISPLAY:-host.docker.internal:0.0}
      - DOCKER_HOST=${DOCKER_HOST:-unix:///var/run/docker.sock}
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility,graphics
    volumes:
      - "E:/Docker_folders/kali:/home/kali"
      - ./kali/entrypoint_kali.sh:/entrypoint_kali.sh
      - ./kali/kali_scripts:/custom_scripts
      - ./kali/id_rsa_n8n_kali.pub:/root/.ssh/authorized_keys
      - '/sys/fs/cgroup:/sys/fs/cgroup:rw'
      - /var/run/docker.sock:/var/run/docker.sock
    entrypoint: ["/bin/bash", "/entrypoint_kali.sh"]
    ports:
      - "38081:80"
      - "44443:443"
      - "22222:22"
    restart: unless-stopped

  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    hostname: pihole
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "8090:80"          # Panel web (NPM ya usa 80/443)
    environment:
      - TZ=Europe/Madrid
      - WEBPASSWORD=${PIHOLE_WEBPASSWORD:-admin}   # cámbialo en .env
      - DNSMASQ_LISTENING=all
      # Si usas Unbound, configúralo luego en la UI a 127.0.0.1#5335
    volumes:
      - "E:/Docker_folders/pihole/etc-pihole:/etc/pihole"
      - "E:/Docker_folders/pihole/dnsmasq.d:/etc/dnsmasq.d"
    restart: unless-stopped

#  clamav:
#    image: mkodockx/docker-clamav:latest
#    container_name: clamav
#    ports:
#      - "33049:3310"
#    volumes:
#      - "E:/Docker_folders/clamav:/var/lib/clamav"
#    restart: unless-stopped

  py-runner:
    build:
      context: ./python_scripts
      dockerfile: Dockerfile
    container_name: py-runner
    environment:
      - TZ=Europe/Madrid
      - SUPERVISOR_USER=admin
      - SUPERVISOR_PASSWORD=admin
      - SCRIPTS_DIR=/workspace/scripts
      - LOGS_DIR=/workspace/logs
      - REQUIREMENTS_FILE=/workspace/requirements.txt
      - CRON_FILE=/workspace/schedule.cron
      - AUTO_REGISTER_INTERVAL=5   # opcional (segundos)
    ports:
      - "9012:9001"   # UI web de Supervisor
      - "9013:9001"   # Supervisor (backend)
      - "9014:8000"   # UI moderno (FastAPI)
    volumes:
      - "E:/Docker_folders/python_scripts:/workspace"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9001 >/dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s

  #emulerr:
  #  image: isc30/emulerr:latest
  #  container_name: emulerr
  #  restart: unless-stopped
  #  tty: true
  #  environment:
  #    - TZ=Europe/Madrid
  #    - PASSWORD=admin
  #    - LOG_LEVEL=debug
  #  ports:
  #    - "39000:3000"          # UI eMulerr
  #    - "39062:39062/tcp"     # eD2K TCP
  #    - "39062:39062/udp"     # Kad/Cliente UDP 
  #    - "39065:39065/udp"     # Server UDP
  #    - "39011:39011/tcp"     # amuleweb 
  #    - "39012:39012/tcp"     # EC/Remote 
  #  volumes:
  #    - "D:/Descargas/eMule:/downloads"
  #    - "./emulerr-amule:/home/amule/.aMule"
  #    # - "./emulerr-amule/server.met:/config/amule/server.met"
  #    # - "./emulerr-amule/amule.overrides.conf:/config/amule/amule.overrides.conf"

  amule:
    image: ghcr.io/ngosang/amule:latest   # alternativa: ngosang/amule
    container_name: amule
    ports:
      - "4711:4711"          # WebUI
      - "4712:4712"          # EC/Remote GUI (amulecmd/amarr)
      - "4662:4662"          # ED2K TCP
      - "4665:4665/udp"      # ED2K global search UDP (TCP+3)
      - "4672:4672/udp"      # ED2K Kad UDP
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Madrid
      - GUI_PWD=${AMULE_GUI_PWD:-amuleadmin}     # misma pass que usará Amarr
      - WEBUI_PWD=${AMULE_WEBUI_PWD:-amuleadmin}
      # Mods útiles y seguros
      - MOD_AUTO_RESTART_ENABLED=true
      - MOD_AUTO_RESTART_CRON=0 6 * * *
      - MOD_FIX_KAD_GRAPH_ENABLED=true
      - MOD_FIX_KAD_BOOTSTRAP_ENABLED=true
    volumes:
      - "E:/Docker_folders/amule/config:/home/amule/.aMule"
      - "D:/Descargas/eMule/complete:/incoming"
      - "D:/Descargas/eMule/incomplete:/temp"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:4711/ >/dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 10
      start_period: 120s

  amarr:
    image: vexdev/amarr:latest
    container_name: amarr
    depends_on:
      - amule
    ports:
      - "33120:8080"   # UI/endpoint Torznab y cliente simulado
    environment:
      - AMULE_HOST=amule
      - AMULE_PORT=4712
      - AMULE_PASSWORD=${AMULE_GUI_PWD:-amuleadmin}  # coincide con GUI_PWD de aMule
      - AMARR_LOG_LEVEL=INFO
      - AMULE_FINISHED_PATH=/incoming                 # coincide con aMule
    volumes:
      - "E:/Docker_folders/amarr:/config"
    restart: unless-stopped

  metube:
    image: ghcr.io/alexta69/metube:latest
    container_name: metube
    restart: unless-stopped
    ports:
      - "8081:8081"          # UI web de MeTube
    environment:
      - TZ=Europe/Madrid
      # Opcional: explícito, pero por defecto ya usan /downloads
      - DOWNLOAD_DIR=/downloads
      - AUDIO_DOWNLOAD_DIR=/downloads
    volumes:
      # Carpeta de descargas en el host -> carpeta interna de MeTube
      - "E:/YouTube:/downloads"

  # --- Prueba de GPU -------------------------------------------------------
  #test-gpu:
  #  image: nvidia/cuda:12.9.0-base-ubuntu22.04
  #  container_name: test-gpu
  #  command: nvidia-smi
  #  deploy:
  #    resources:
  #      reservations:
  #        devices:
  #          - driver: nvidia
  #            count: 1
  #            capabilities: [gpu]
  #  restart: "no"
